<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>bibleRPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1222; --panel:#151936; --panel-2:#1c2150; --accent:#7aa2ff; --accent-2:#70f0c4;
      --text:#e9ebff; --muted:#9aa3cf; --good:#70f0c4; --warn:#ffd166; --bad:#ff6b6b;
      --btn:#222a63; --btn-hover:#2a3482; --chip:#232a5a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:24px/1.4 system-ui,'AR CENA',Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text); background:linear-gradient(180deg,#0f1222 0%,#0f1428 70%,#0f1222 100%);
    }
    header{
      padding:16px 20px; border-bottom:1px solid #2b336b; background:rgba(12,14,30,.7); backdrop-filter: blur(6px);
      display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:2;
    }
    header h1{margin:0; font-size:30px; font-weight:700; letter-spacing:.3px}
    header .subtitle{color:var(--muted); font-size:26px}
    main{
      display:grid; grid-template-columns: 2.2fr 1.2fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto;
    }
    @media (max-width: 920px){ main{grid-template-columns: 1fr} }
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%); border:1px solid #262e66; border-radius:12px; overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .card h2{
      margin:0; padding:12px 14px; font-size:14px; color:var(--muted); letter-spacing:.4px; text-transform:uppercase; border-bottom:1px solid #27306a;
      background:linear-gradient(180deg,#1a1f48 0%,#151936 100%); position:sticky; top:48px; z-index:1;
    }
    .section{padding:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:10px}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid #2a3470; color:var(--text); font-size:13px;
    }
    .bar{
      height:8px; background:#1b1f45; border-radius:999px; overflow:hidden; border:1px solid #2a3270;
    }
    .bar > i{
      display:block; height:100%; background:linear-gradient(90deg,var(--accent) 0%, var(--accent-2) 100%); width:0%;
      transition:width .35s ease;
    }
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius:10px; padding:10px 12px; background:var(--btn); color:var(--text);
      border:1px solid #2a3470; font-weight:600; letter-spacing:.2px; transition: all .15s ease;
    }
    .btn:hover{background:var(--btn-hover); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-row{display:flex; gap:10px; flex-wrap:wrap}
    .choice{display:flex; flex-direction:column; gap:6px; min-width:260px}
    .choice small{color:var(--muted)}
    select, .input{
      background:#161b3f; color:var(--text); border:1px solid #2a3470; border-radius:8px; padding:8px 10px; font-weight:600;
    }
    .log{
      height:220px; overflow:auto; background:rgba(9,11,24,.55); border:1px solid #262f68; border-radius:10px; padding:10px;
    }
    .log p{margin:0 0 8px}
    .token{display:inline-block; margin:4px 6px 0 0; padding:6px 8px; border-radius:8px; border:1px solid #27306a; background:#171b3d; font-size:13px}
    .kv{display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; align-items:center}
    .divider{height:1px; background:#27306a; margin:10px 0}
    .footer{padding:10px 16px; color:var(--muted); font-size:12px; text-align:center}
    .title-ribbon{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:8px; border:1px solid #2a3470; background:linear-gradient(180deg,#1c2456,#14193d);
      box-shadow: inset 0 0 12px rgba(112,240,196,.12);
    }
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .sr{position:absolute; left:-9999px}
    
    /* Scene Management */
    .scene{
      opacity:0; transition: opacity 0.5s ease-in-out;
      animation-fill-mode: forwards; 
      visibility: hidden; pointer-events:none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      overflow-y: auto;
    }
    .scene.active{
      opacity:1; visibility: visible; pointer-events:auto;
      position: relative; height: auto;
    }
    .scene.fade-in{
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    .scene.fade-out{
      animation: fadeOut 0.5s ease-in-out forwards;
    }
    @keyframes fadeIn{
      from{opacity:0} to{opacity:1}
    }
    @keyframes fadeOut{
      from{opacity:1} to{opacity:0}
    }
    
    /* Title Scene Styles */
    .title-scene{
      min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; padding:40px 20px; background:linear-gradient(180deg,#0f1222 0%,#0f1428 50%,#1a1f48 100%);
    }
    .title-logo{
      font-size:72px; margin-bottom:20px; text-shadow:0 0 20px var(--accent);
    }
    .title-heading{
      font-size:48px; font-weight:700; margin:0 0 16px; letter-spacing:1px;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .title-subtitle{
      font-size:24px; color:var(--muted); margin:0 0 40px; letter-spacing:0.5px;
    }
    .title-button{
      font-size:20px; padding:16px 32px; background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:0.5px;
      box-shadow:0 8px 24px rgba(122,162,255,0.3); transition:all 0.3s ease;
      margin:8px;
    }
    .title-button:hover{
      transform:translateY(-2px); box-shadow:0 12px 32px rgba(122,162,255,0.4);
    }
    
    /* Introduction Scene Styles */
    .intro-scene{
      min-height:100vh; padding:40px 20px; display:flex; flex-direction:column; justify-content:center;
      max-width:800px; margin:0 auto; text-align:center;
    }
    .intro-content{
      background:var(--panel); border:1px solid #262e66; border-radius:12px; padding:40px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .intro-text{
      font-size:18px; line-height:1.6; color:var(--text); margin:0 0 32px;
    }
    
    /* Settings Scene Styles */
    .settings-scene{
      min-height:100vh; padding:40px 20px; max-width:600px; margin:0 auto;
    }
    .settings-content{
      background:var(--panel); border:1px solid #262e66; border-radius:12px; padding:40px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .setting-item{
      display:flex; justify-content:space-between; align-items:center; padding:16px 0;
      border-bottom:1px solid #2a3470;
    }
    .setting-item:last-child{border-bottom:none}
    .setting-label{
      font-size:16px; color:var(--text);
    }
    .setting-control{
      display:flex; align-items:center; gap:12px;
    }
    
    /* Credits Scene Styles */
    .credits-scene{
      min-height:100vh; padding:40px 20px; max-width:700px; margin:0 auto; text-align:center;
    }
    .credits-content{
      background:var(--panel); border:1px solid #262e66; border-radius:12px; padding:40px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .credits-section{
      margin:32px 0;
    }
    .credits-section h3{
      color:var(--accent); font-size:20px; margin:0 0 16px; text-transform:uppercase; letter-spacing:0.5px;
    }
    .credits-list{
      color:var(--text); font-size:16px; line-height:1.6;
    }
    
    /* Navigation Styles */
    .nav-buttons{
      position:fixed; top:20px; right:20px; z-index:1000; display:flex; gap:12px;
    }
    .nav-btn{
      background:rgba(22,27,63,0.9); border:1px solid #2a3470; color:var(--text);
      padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; backdrop-filter:blur(6px);
      transition:all 0.2s ease;
    }
    .nav-btn:hover{
      background:var(--btn-hover); transform:translateY(-1px);
    }
    .back-btn{
      position:absolute; top:20px; left:20px; z-index:1000;
    }
  </style>
</head>
<body>
  <!-- Navigation Buttons (hidden on title screen) -->
  <nav class="nav-buttons" id="navButtons" style="display:none;" aria-label="Scene navigation">
    <button class="nav-btn" onclick="showScene('settings')" aria-label="Open settings">‚öôÔ∏è</button>
    <button class="nav-btn" onclick="showScene('credits')" aria-label="View credits">‚ÑπÔ∏è</button>
  </nav>

  <!-- Title Screen Scene -->
  <section class="scene title-scene active" id="titleScene" role="main" aria-labelledby="titleHeading">
    <div class="title-logo" aria-hidden="true">‚úùÔ∏è</div>
    <h1 class="title-heading" id="titleHeading">bibleRPG</h1>
    <p class="title-subtitle">Hear What The Spirit Says To The Soul!</p>
    <div>
      <button class="title-button" onclick="showScene('intro')" aria-describedby="startGameDesc">
        Start Journey
      </button>
      <button class="title-button" onclick="showScene('gameplay')" aria-describedby="continueGameDesc">
        Continue Adventure
      </button>
    </div>
    <div class="sr">
      <span id="startGameDesc">Begin a new spiritual journey</span>
      <span id="continueGameDesc">Resume your existing adventure</span>
    </div>
  </section>

  <!-- Introduction Scene -->
  <section class="scene intro-scene" id="introScene" role="main" aria-labelledby="introHeading">
    <button class="back-btn nav-btn" onclick="showScene('title')" aria-label="Back to title screen">‚Üê Back</button>
    <div class="intro-content">
      <h2 id="introHeading" style="color:var(--accent); font-size:32px; margin:0 0 24px;">Welcome, Faithful Traveler</h2>
      <div class="intro-text">
        <p>In the lands where our Savior once walked, a spiritual journey awaits you. As a faithful follower, you will travel through biblical locations, face moral choices, and grow in Faith, Wisdom, and Service.</p>
        <p>Your decisions will shape your character and determine the quests available to you. Seek guidance through prayer, consult the wisdom of elders, and serve those in need along your path.</p>
        <p>May the Spirit guide your steps as you embark on this sacred adventure.</p>
      </div>
      <button class="title-button" onclick="showScene('gameplay')" aria-label="Begin the adventure">
        Begin Adventure
      </button>
    </div>
  </section>

  <!-- Main Gameplay Scene -->
  <section class="scene" id="gameplayScene" role="main" aria-labelledby="gameplayHeading">
    <button class="back-btn nav-btn" onclick="showScene('title')" aria-label="Back to title screen">‚Üê Menu</button>
    
    <header>
      <div style="font-size:18px">‚úùÔ∏è</div>
      <div>
        <h1 id="gameplayHeading">bibleRPG</h1>
        <div class="subtitle">Hear What The Spirit Says To The Soul!</div>
      </div>
    </header>

    <main>
    <section class="card" aria-live="polite" aria-atomic="true">
      <h2>Adventure</h2>
      <div class="section stack">
        <div class="row" id="locationRow">
          <span class="pill">üìç <strong id="locName">Location</strong></span>
          <label class="pill" for="travelSelect">üß≠ <strong>Travel</strong></label>
          <select id="travelSelect" aria-label="Choose destination"></select>
          <button class="btn" id="travelBtn">Go</button>
          <button class="btn" id="resetBtn" title="Clear progress">Reset</button>
        </div>

        <div class="stack">
          <div id="scenario" class="section" style="background:#0f132e;border:1px solid #262f68;border-radius:10px"></div>
          <div class="btn-row" id="choices"></div>
        </div>

        <div class="stack">
          <div class="kv">
            <div>Faith</div>
            <div class="bar" title="Faith"><i id="faithBar"></i></div>
            <div>Wisdom</div>
            <div class="bar" title="Wisdom"><i id="wisdomBar"></i></div>
            <div>Service</div>
            <div class="bar" title="Service"><i id="serviceBar"></i></div>
          </div>
          <div class="divider"></div>
          <div class="row">
            <div class="title-ribbon">üèÖ <span id="titleValue">Service Title</span></div>
          </div>
        </div>

        <div>
          <h3 style="margin:8px 0 6px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">Event log</h3>
          <div class="log" id="log" role="log" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Profile</h2>
      <div class="section stack">
        <div class="stack">
          <div class="row"><span class="pill">üìä <strong>Stats</strong></span></div>
          <div class="kv">
            <div>Faith:</div><div id="faithVal">0</div>
            <div>Wisdom:</div><div id="wisdomVal">0</div>
            <div>Service:</div><div id="serviceVal">0</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="stack">
          <div class="row"><span class="pill">üéÅ <strong>Rewards:</strong></span></div>
          <div id="rewards" class="row"></div>
        </div>

        <div class="divider"></div>

        <div class="stack">
          <div class="row"><span class="pill">üó°Ô∏è <strong>Quest:</strong></span></div>
          <div id="questBox" class="stack"></div>
        </div>
      </div>
    </aside>
    </main>

    <div class="footer">2025 @ bibleRPG</div>
  </section>

  <!-- Settings Scene -->
  <section class="scene settings-scene" id="settingsScene" role="main" aria-labelledby="settingsHeading">
    <button class="back-btn nav-btn" onclick="showScene('title')" aria-label="Back to title screen">‚Üê Back</button>
    <div class="settings-content">
      <h2 id="settingsHeading" style="color:var(--accent); font-size:32px; margin:0 0 32px; text-align:center;">Settings</h2>
      
      <div class="setting-item">
        <label class="setting-label" for="soundToggle">Sound Effects</label>
        <div class="setting-control">
          <input type="checkbox" id="soundToggle" checked aria-describedby="soundDesc">
          <span class="sr" id="soundDesc">Toggle sound effects on or off</span>
        </div>
      </div>
      
      <div class="setting-item">
        <label class="setting-label" for="musicToggle">Background Music</label>
        <div class="setting-control">
          <input type="checkbox" id="musicToggle" checked aria-describedby="musicDesc">
          <span class="sr" id="musicDesc">Toggle background music on or off</span>
        </div>
      </div>
      
      <div class="setting-item">
        <label class="setting-label" for="difficultySelect">Difficulty</label>
        <div class="setting-control">
          <select id="difficultySelect" aria-describedby="difficultyDesc">
            <option value="easy">Beginner</option>
            <option value="normal" selected>Faithful</option>
            <option value="hard">Devoted</option>
          </select>
          <span class="sr" id="difficultyDesc">Choose game difficulty level</span>
        </div>
      </div>
      
      <div class="setting-item">
        <label class="setting-label" for="textSizeSelect">Text Size</label>
        <div class="setting-control">
          <select id="textSizeSelect" aria-describedby="textSizeDesc">
            <option value="small">Small</option>
            <option value="normal" selected>Normal</option>
            <option value="large">Large</option>
          </select>
          <span class="sr" id="textSizeDesc">Adjust text size for better readability</span>
        </div>
      </div>
      
      <div class="setting-item">
        <label class="setting-label" for="autoSaveToggle">Auto-Save</label>
        <div class="setting-control">
          <input type="checkbox" id="autoSaveToggle" checked aria-describedby="autoSaveDesc">
          <span class="sr" id="autoSaveDesc">Automatically save game progress</span>
        </div>
      </div>
      
      <div style="text-align:center; margin-top:32px;">
        <button class="title-button" onclick="saveSettings()" aria-label="Save all settings">
          Save Settings
        </button>
      </div>
    </div>
  </section>

  <!-- Credits Scene -->
  <section class="scene credits-scene" id="creditsScene" role="main" aria-labelledby="creditsHeading">
    <button class="back-btn nav-btn" onclick="showScene('title')" aria-label="Back to title screen">‚Üê Back</button>
    <div class="credits-content">
      <h2 id="creditsHeading" style="color:var(--accent); font-size:32px; margin:0 0 32px;">Credits & Acknowledgments</h2>
      
      <div class="credits-section">
        <h3>Game Development</h3>
        <div class="credits-list">
          <p><strong>Lead Developer:</strong> Adam F</p>
          <p><strong>UI/UX Design:</strong> bibleRPG Team</p>
          <p><strong>Game Mechanics:</strong> Community Contributors</p>
        </div>
      </div>
      
      <div class="credits-section">
        <h3>Spiritual Content</h3>
        <div class="credits-list">
          <p><strong>Scripture References:</strong> Holy Bible (Various Translations)</p>
          <p><strong>Biblical Locations:</strong> Historical Research</p>
          <p><strong>Moral Guidance:</strong> Christian Ethics Scholars</p>
        </div>
      </div>
      
      <div class="credits-section">
        <h3>Technical Framework</h3>
        <div class="credits-list">
          <p><strong>Frontend:</strong> HTML5, CSS3, JavaScript</p>
          <p><strong>Icons:</strong> Unicode Emoji</p>
          <p><strong>Accessibility:</strong> ARIA Standards</p>
        </div>
      </div>
      
      <div class="credits-section">
        <h3>Special Thanks</h3>
        <div class="credits-list">
          <p>To all believers who seek to grow in Faith, Wisdom, and Service</p>
          <p>Open source community for inspiration and support</p>
          <p>Beta testers and feedback contributors</p>
        </div>
      </div>
      
      <div style="text-align:center; margin-top:32px;">
        <p style="color:var(--muted); font-style:italic;">
          "But those who hope in the Lord will renew their strength" - Isaiah 40:31
        </p>
      </div>
    </div>
  </section>

  <script>
    // ----------------------------
    // Scene Management
    // ----------------------------
    let currentScene = 'title';
    
    function showScene(sceneName) {
      const scenes = document.querySelectorAll('.scene');
      const navButtons = document.getElementById('navButtons');
      
      // Hide current scene with fade out
      const currentSceneEl = document.getElementById(currentScene + 'Scene');
      if (currentSceneEl) {
        currentSceneEl.classList.add('fade-out');
        currentSceneEl.addEventListener('animationend', function handleFadeOut() {
          currentSceneEl.classList.remove('active', 'fade-out');
          currentSceneEl.removeEventListener('animationend', handleFadeOut);
          
          // Show new scene with fade in
          const newSceneEl = document.getElementById(sceneName + 'Scene');
          if (newSceneEl) {
            newSceneEl.classList.add('active', 'fade-in');
            newSceneEl.addEventListener('animationend', function handleFadeIn() {
              newSceneEl.classList.remove('fade-in');
              newSceneEl.removeEventListener('animationend', handleFadeIn);
            }, { once: true });
          }
        }, { once: true });
      }
      
      currentScene = sceneName;
      
      // Show/hide navigation buttons based on scene
      if (sceneName === 'title') {
        navButtons.style.display = 'none';
      } else {
        navButtons.style.display = 'flex';
      }
      
      // Announce scene change for screen readers
      announceSceneChange(sceneName);
    }
    
    function announceSceneChange(sceneName) {
      const announcer = document.createElement('div');
      announcer.setAttribute('aria-live', 'polite');
      announcer.setAttribute('aria-atomic', 'true');
      announcer.className = 'sr';
      announcer.textContent = `Navigated to ${sceneName} scene`;
      document.body.appendChild(announcer);
      setTimeout(() => document.body.removeChild(announcer), 1000);
    }
    
    // ----------------------------
    // Settings Management
    // ----------------------------
    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('bibleRPG_settings') || '{}');
      
      // Apply saved settings
      if (settings.sound !== undefined) {
        document.getElementById('soundToggle').checked = settings.sound;
      }
      if (settings.music !== undefined) {
        document.getElementById('musicToggle').checked = settings.music;
      }
      if (settings.difficulty) {
        document.getElementById('difficultySelect').value = settings.difficulty;
      }
      if (settings.textSize) {
        document.getElementById('textSizeSelect').value = settings.textSize;
        applyTextSize(settings.textSize);
      }
      if (settings.autoSave !== undefined) {
        document.getElementById('autoSaveToggle').checked = settings.autoSave;
      }
    }
    
    function saveSettings() {
      const settings = {
        sound: document.getElementById('soundToggle').checked,
        music: document.getElementById('musicToggle').checked,
        difficulty: document.getElementById('difficultySelect').value,
        textSize: document.getElementById('textSizeSelect').value,
        autoSave: document.getElementById('autoSaveToggle').checked
      };
      
      localStorage.setItem('bibleRPG_settings', JSON.stringify(settings));
      applyTextSize(settings.textSize);
      
      // Show confirmation
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Settings Saved!';
      button.style.background = 'var(--good)';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '';
      }, 2000);
    }
    
    function applyTextSize(size) {
      const root = document.documentElement;
      switch(size) {
        case 'small':
          root.style.fontSize = '20px';
          break;
        case 'large':
          root.style.fontSize = '28px';
          break;
        default:
          root.style.fontSize = '24px';
      }
    }
    
    // ----------------------------
    // Keyboard Navigation
    // ----------------------------
    document.addEventListener('keydown', function(e) {
      // ESC key to go back to title
      if (e.key === 'Escape' && currentScene !== 'title') {
        showScene('title');
      }
      
      // Prevent default behavior only for our custom keys
      if (['Escape'].includes(e.key)) {
        e.preventDefault();
      }
    });

    // ----------------------------
    // ----------------------------
    // Data tables
    // ----------------------------
    const LOCATIONS = ['Galilee','Jerusalem', 'Bethlehem', 'Damascus', 'Wilderness', 'Israel', 'Sea of Galilee', 'Babylon'];

    const locationFlavors = {
      Galilee: [
        'You arrive by the Sea of Galilee as dawn gilds the water.',
        'Fishermen mend their nets; gulls arc over the tide.',
        'A hush falls as the wind softens across the shore.'
      ],
      Jerusalem: [
        'Stone steps climb toward the Temple courts, alive with voices.',
        'Shadows of pillars stretch long across the courtyard.',
        'Whispers of prophecy linger in the narrow streets.'
      ]
    };

    const questPool = {
      Galilee: [
        {
          id:'fishers_of_men',
          description:'Share the Good News with the villagers by the shore.',
          requirements:{faith:2},
          reward:{type:'title', value:'Fisher of Men'},
          scripture:'Matthew 4:19'
        },
        {
          id:'calm_the_storm',
          description:'Pray for calm as the winds rise over the sea.',
          requirements:{faith:4, wisdom:2},
          reward:{type:'miracle', value:'Calmed Storm'},
          scripture:'Mark 4:39'
        }
      ],
      Jerusalem: [
        {
          id:'teach_in_temple',
          description:'Engage in debate with the teachers in the temple courts.',
          requirements:{wisdom:3},
          reward:{type:'item', value:'Scroll of Insight'},
          scripture:'Luke 2:46-47'
        }
      ]
    };

    const milestones = {
      faith: { 5: { type:'miracle', value:'Parted Waters' } },
      wisdom:{ 5: { type:'miracle', value:'Prophetic Vision' } },
      service:{ 5: { type:'miracle', value:'Feeding the Multitude' } }
    };

    const locationBlessings = {
      Galilee: [
        {
          requirements:{faith:3},
          blessing:{type:'vision', value:'A net overflowing with fish ‚Äî a promise of abundance.'},
          scripture:'Luke 5:6'
        }
      ],
      Jerusalem: [
        {
          requirements:{wisdom:4, service:2},
          blessing:{type:'favor', value:'The elders grant you access to the inner courts.'},
          scripture:'Acts 6:10'
        }
      ]
    };

    const choicesData = [
      { id:'faith_choice', label:'üôè Wait upon the Lord‚Äôs guidance', stat:'faith', scripture:'Isaiah 40:31' },
      { id:'wisdom_choice', label:'üìñ Seek counsel from the elders', stat:'wisdom', scripture:'Proverbs 11:14' },
      { id:'service_choice', label:'ü§ù Help the wounded traveler', stat:'service', scripture:'Luke 10:33‚Äì34' }
    ];

    // ----------------------------
    // State & persistence
    // ----------------------------
    const STORAGE_KEY = 'gospel_rpg_state_v1';

    const defaultState = () => ({
      stats:{ faith:0, wisdom:0, service:0 },
      location:[],
      rewards:[],   // array of {type,value}
      items:[],     // derived from rewards
      title:[],
      achievedMilestones:{}, // e.g., "faith:5":true
      currentQuest:[],
      log:[]
    });

    let state = load();

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : defaultState();
      }catch{ return defaultState() }
    }
    function reset(){
      state = defaultState();
      addLog('üîÑ Progress reset.');
      enterLocation(state.location, {announce:false});
      render();
      save();
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    const $ = sel => document.querySelector(sel);
    function el(tag, props={}, children=[]){
      const e = document.createElement(tag);
      Object.entries(props).forEach(([k,v])=>{
        if(k==='class') e.className = v;
        else if(k==='html') e.innerHTML = v;
        else e.setAttribute(k, v);
      });
      [].concat(children).forEach(c => {
        if(typeof c === 'string') e.appendChild(document.createTextNode(c));
        else if(c) e.appendChild(c);
      });
      return e;
    }
    const pick = arr => arr[Math.floor(Math.random()*arr.length)];
    const meets = (stats, reqs) => Object.entries(reqs).every(([s,val]) => (stats[s]||0) >= val);
    const rewardKey = r => `${r.type}:${r.value}`;
    const hasReward = r => state.rewards.some(x => rewardKey(x)===rewardKey(r));

    function addLog(line){
      state.log.unshift(line);
      state.log = state.log.slice(0, 80);
    }

    // ----------------------------
    // Core systems
    // ----------------------------
    function scenarioFor(location){
      return pick(locationFlavors[location] || ['You continue on your way.']);
    }

    function assignQuest(location){
      const pool = questPool[location] || [];
      const candidates = pool.filter(q => meets(state.stats, q.requirements));
      if(!candidates.length) return null;
      return pick(candidates);
    }

    function applyReward(reward){
      if(!hasReward(reward)) state.rewards.push(reward);

      switch(reward.type){
        case 'miracle':
          addLog(`üåü Miracle! ${reward.value}`);
          return `üåü Miracle! ${reward.value}`;
        case 'title':
          state.title = reward.value;
          addLog(`üèÖ You are now known as ‚Äú${reward.value}‚Äù.`);
          return `üèÖ You are now known as ‚Äú${reward.value}‚Äù.`;
        case 'item':
          if(!state.items.includes(reward.value)) state.items.push(reward.value);
          addLog(`üì¶ You obtained: ${reward.value}`);
          return `üì¶ You obtained: ${reward.value}`;
        case 'vision':
          addLog(`üëÅÔ∏è Vision: ${reward.value}`);
          return `üëÅÔ∏è Vision: ${reward.value}`;
        case 'favor':
          addLog(`üí† Favor: ${reward.value}`);
          return `üí† Favor: ${reward.value}`;
        default:
          return '';
      }
    }

    function checkMilestones(){
      const notes = [];
      for(const stat of Object.keys(milestones)){
        const cur = state.stats[stat] || 0;
        const table = milestones[stat] || {};
        if(table[cur]){
          const key = `${stat}:${cur}`;
          if(!state.achievedMilestones[key]){
            state.achievedMilestones[key] = true;
            notes.push(applyReward(table[cur]));
          }
        }
      }
      return notes;
    }

    function checkLocationBlessings(location){
      const list = locationBlessings[location] || [];
      const notes = [];
      list.forEach(b => {
        if(meets(state.stats, b.requirements)){
          notes.push(`${applyReward(b.blessing)} (${b.scripture})`);
        }
      });
      return notes;
    }

    function enterLocation(location, {announce=true}={}){
      state.location = location;
      const lines = [];

      if(announce){
        lines.push(`üß≠ You arrive in ${location}.`);
      }
      lines.push(scenarioFor(location));

      const blessings = checkLocationBlessings(location);
      if(blessings.length) lines.push(...blessings);

      // Assign a quest if eligible (immediate completion demo)
      const q = assignQuest(location);
      state.currentQuest = q;
      if(q){
        lines.push(`üó°Ô∏è Quest: ${q.description} (${q.scripture})`);
        // In this single-file demo we auto-complete for momentum
        const rewardMsg = applyReward(q.reward);
        lines.push(`‚úÖ Quest Completed: ${q.description}`);
        if(rewardMsg) lines.push(rewardMsg);
      }else{
        lines.push('üó°Ô∏è No quests available yet. Grow in your stats to unlock more.');
      }

      addLog(lines.join(' '));
      $('#scenario').innerHTML = lines.map(l => `<p>${l}</p>`).join('');
      save();
    }

    function handleChoice(choiceId){
      const choice = choicesData.find(c => c.id===choiceId);
      if(!choice) return;

      const stat = choice.stat;
      state.stats[stat] = (state.stats[stat]||0) + 1;

      const choiceLine = `‚ú® You chose: ${choice.label} (${choice.scripture})`;
      addLog(choiceLine);

      const milestoneNotes = checkMilestones();
      const nextIndex = (LOCATIONS.indexOf(state.location)+1) % LOCATIONS.length;
      const nextLoc = LOCATIONS[nextIndex];

      const lines = [choiceLine];
      if(milestoneNotes.length) lines.push(...milestoneNotes);

      $('#scenario').innerHTML = lines.map(l => `<p>${l}</p>`).join('');

      // Travel after a short beat to simulate turn flow
      setTimeout(()=>{
        enterLocation(nextLoc);
        render();
      }, 400);

      render();
      save();
    }

    // ----------------------------
    // UI wiring
    // ----------------------------
    function render(){
      // Location
      $('#locName').textContent = state.location;
      // Stats values
      $('#faithVal').textContent = state.stats.faith;
      $('#wisdomVal').textContent = state.stats.wisdom;
      $('#serviceVal').textContent = state.stats.service;
      // Bars (cap at 10 for display)
      const cap = v => Math.max(0, Math.min(10, v));
      $('#faithBar').style.width = (cap(state.stats.faith)*10)+'%';
      $('#wisdomBar').style.width = (cap(state.stats.wisdom)*10)+'%';
      $('#serviceBar').style.width = (cap(state.stats.service)*10)+'%';

      // Title
      $('#titleValue').textContent = state.title || 'No title yet';

      // Rewards
      const rewardsBox = $('#rewards');
      rewardsBox.innerHTML = '';
      if(!state.rewards.length){
        rewardsBox.appendChild(el('div',{class:'muted'},['No rewards yet']));
      }else{
        state.rewards.forEach(r=>{
          rewardsBox.appendChild(el('span',{class:'token'},[`${iconFor(r.type)} ${r.value}`]));
        });
      }

      // Quest box
      const qb = $('#questBox');
      qb.innerHTML = '';
      if(state.currentQuest){
        qb.appendChild(el('div',{class:'stack'},[
          el('div',{class:'row'},[el('span',{class:'pill'},[`üìú `, el('strong',{},['Description'])]), el('span',{},[state.currentQuest.description])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`üìñ `, el('strong',{},['Scripture'])]), el('span',{},[state.currentQuest.scripture])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`üéØ `, el('strong',{},['Requirements'])]),
            el('span',{},[reqText(state.currentQuest.requirements)])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`üéÅ `, el('strong',{},['Reward'])]),
            el('span',{},[`${state.currentQuest.reward.type}: ${state.currentQuest.reward.value}`])])
        ]));
      }else{
        qb.appendChild(el('div',{class:'muted'},['No active quest.']));
      }

      // Choices
      const choices = $('#choices');
      choices.innerHTML = '';
      choicesData.forEach(c=>{
        const btn = el('button',{class:'btn', id:c.id},[c.label]);
        const sub = el('small',{},[c.scripture]);
        const wrap = el('div',{class:'choice'},[btn, sub]);
        btn.addEventListener('click', ()=>handleChoice(c.id));
        choices.appendChild(wrap);
      });

      // Log
      const log = $('#log');
      log.innerHTML = state.log.map(line=>`<p>${line}</p>`).join('');
    }

    function iconFor(type){
      switch(type){
        case 'miracle': return 'üåü';
        case 'title': return 'üèÖ';
        case 'item': return 'üì¶';
        case 'vision': return 'üëÅÔ∏è';
        case 'favor': return 'üí†';
        default: return 'üéÅ';
      }
    }
    function reqText(reqs){
      const parts = [];
      if('faith' in reqs) parts.push(`Faith ${reqs.faith}+`);
      if('wisdom' in reqs) parts.push(`Wisdom ${reqs.wisdom}+`);
      if('service' in reqs) parts.push(`Service ${reqs.service}+`);
      return parts.join(', ') || 'None';
    }

    function initUI(){
      // Travel control
      const sel = $('#travelSelect');
      sel.innerHTML = '';
      LOCATIONS.forEach(loc=>{
        const o = el('option',{value:loc},[loc]);
        sel.appendChild(o);
      });
      sel.value = state.location;
      $('#travelBtn').addEventListener('click', ()=>{
        const dest = sel.value;
        if(dest && dest !== state.location){
          enterLocation(dest);
          render();
          save();
        }
      });
      // Reset
      $('#resetBtn').addEventListener('click', reset);
    }

    // ----------------------------
    // Boot
    // ----------------------------
    window.addEventListener('DOMContentLoaded', ()=>{
      // Initialize settings
      loadSettings();
      
      // Initialize UI only when in gameplay scene
      if (currentScene === 'gameplay') {
        initUI();
        // First-time arrival narrative
        if(state.log.length===0){
          enterLocation(state.location, {announce:true});
        }else{
          // Ensure scenario shows something on reload
          $('#scenario').innerHTML = state.log.slice(0,3).reverse().map(l=>`<p>${l}</p>`).join('');
        }
        render();
        save();
      }
    });
    
    // Initialize gameplay when entering gameplay scene
    function initGameplay() {
      initUI();
      // First-time arrival narrative
      if(state.log.length===0){
        enterLocation(state.location, {announce:true});
      }else{
        // Ensure scenario shows something on reload
        $('#scenario').innerHTML = state.log.slice(0,3).reverse().map(l=>`<p>${l}</p>`).join('');
      }
      render();
      save();
    }
    
    // Override showScene to handle gameplay initialization
    const originalShowScene = showScene;
    showScene = function(sceneName) {
      originalShowScene(sceneName);
      if (sceneName === 'gameplay') {
        // Delay initialization to ensure scene is visible
        setTimeout(initGameplay, 100);
      }
    };
  </script>
</body>
</html>
