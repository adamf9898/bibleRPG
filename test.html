<!doctype html>
<html lang="en">
<head>
  <!-- Basic Meta Tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- SEO Meta Tags -->
  <title>bibleRPG - Biblical Adventure Role Playing Game</title>
  <meta name="description" content="Experience biblical adventures in this immersive RPG. Grow in faith, wisdom, and service as you journey through biblical locations and complete scripture-based quests." />
  <meta name="keywords" content="bible, rpg, christian game, biblical adventure, scripture, faith, wisdom, service" />
  <meta name="author" content="bibleRPG Team" />
  <meta name="robots" content="index, follow" />
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="bibleRPG - Biblical Adventure Role Playing Game" />
  <meta property="og:description" content="Experience biblical adventures in this immersive RPG. Grow in faith, wisdom, and service as you journey through biblical locations." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://biblerpg.com/test.html" />
  <meta property="og:image" content="https://biblerpg.com/screenshot.png" />
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="bibleRPG - Biblical Adventure Role Playing Game" />
  <meta name="twitter:description" content="Experience biblical adventures in this immersive RPG." />
  <meta name="twitter:image" content="https://biblerpg.com/screenshot.png" />
  
  <!-- Preload Critical Resources -->
  <link rel="preload" href="#styles" as="style" />
  <link rel="preload" href="#game-script" as="script" />
  <style id="styles">
    /* ==============================================
       CSS Custom Properties (CSS Variables)
       Define the color scheme and theming
       ============================================== */
    :root {
      /* Background Colors */
      --bg: #0f1222;
      --panel: #151936;
      --panel-2: #1c2150;
      
      /* Accent Colors */
      --accent: #7aa2ff;
      --accent-2: #70f0c4;
      
      /* Text Colors */
      --text: #e9ebff;
      --muted: #9aa3cf;
      
      /* Status Colors */
      --good: #70f0c4;
      --warn: #ffd166;
      --bad: #ff6b6b;
      
      /* Interactive Elements */
      --btn: #222a63;
      --btn-hover: #2a3482;
      --chip: #232a5a;
    }
    
    /* ==============================================
       Global Reset and Base Styles
       ============================================== */
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
    }
    
    body {
      margin: 0;
      font: 24px/1.4 system-ui, 'AR CENA', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #0f1222 0%, #0f1428 70%, #0f1222 100%);
    }
    
    /* ==============================================
       Header Styles
       ============================================== */
    header {
      padding: 16px 20px;
      border-bottom: 1px solid #2b336b;
      background: rgba(12, 14, 30, 0.7);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    header h1 {
      margin: 0;
      font-size: 30px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    
    header .subtitle {
      color: var(--muted);
      font-size: 26px;
    }
    
    /* ==============================================
       Main Layout Styles - CSS Grid Implementation
       ============================================== */
    main {
      display: grid;
      grid-template-columns: 2.2fr 1.2fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Responsive Layout for Smaller Screens */
    @media (max-width: 920px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    
    /* Enhanced Mobile Layout */
    @media (max-width: 768px) {
      main {
        padding: 12px;
        gap: 12px;
      }
      
      header {
        padding: 12px 16px;
      }
      
      header h1 {
        font-size: 24px;
      }
      
      header .subtitle {
        font-size: 20px;
      }
    }
    
    /* Small Mobile Optimization */
    @media (max-width: 480px) {
      body {
        font-size: 20px;
      }
      
      main {
        padding: 8px;
        gap: 8px;
      }
    }
    
    /* ==============================================
       Card Component Styles
       ============================================== */
    .card {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid #262e66;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
    }
    
    .card h2 {
      margin: 0;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border-bottom: 1px solid #27306a;
      background: linear-gradient(180deg, #1a1f48 0%, #151936 100%);
      position: sticky;
      top: 48px;
      z-index: 1;
    }
    
    /* ==============================================
       Layout Utility Classes - Flexbox Implementation
       ============================================== */
    .section {
      padding: 14px;
    }
    
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Text Utility Classes */
    .muted {
      color: var(--muted);
    }
    
    .good {
      color: var(--good);
    }
    
    .warn {
      color: var(--warn);
    }
    
    .bad {
      color: var(--bad);
    }
    
    /* Screen Reader Only Content */
    .sr-only {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    
    /* ==============================================
       Interactive Component Styles
       ============================================== */
    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid #2a3470;
      color: var(--text);
      font-size: 13px;
    }
    
    .bar {
      height: 8px;
      background: #1b1f45;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #2a3270;
      position: relative;
    }
    
    .bar > i {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
      width: 0%;
      transition: width 0.35s ease;
    }
    
    /* Button Styles with Enhanced Interactions */
    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--btn);
      color: var(--text);
      border: 1px solid #2a3470;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* Button Loading State */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .choice {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 260px;
      transition: transform 0.2s ease;
    }
    
    .choice:hover {
      transform: translateY(-1px);
    }
    
    .choice small {
      color: var(--muted);
    }
    
    /* Form Controls */
    select, .input {
      background: #161b3f;
      color: var(--text);
      border: 1px solid #2a3470;
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 600;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    select:focus, .input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(122, 162, 255, 0.2);
    }
    
    /* Log and Content Areas */
    .log {
      height: 220px;
      overflow: auto;
      background: rgba(9, 11, 24, 0.55);
      border: 1px solid #262f68;
      border-radius: 10px;
      padding: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    .log::-webkit-scrollbar {
      width: 6px;
    }
    
    .log::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .log::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    
    .log p {
      margin: 0 0 8px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Token and Utility Styles */
    .token {
      display: inline-block;
      margin: 4px 6px 0 0;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #27306a;
      background: #171b3d;
      font-size: 13px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .token:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 10px;
      align-items: center;
    }
    
    .divider {
      height: 1px;
      background: #27306a;
      margin: 10px 0;
    }
    
    .footer {
      padding: 10px 16px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
    
    .title-ribbon {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #2a3470;
      background: linear-gradient(180deg, #1c2456, #14193d);
      box-shadow: inset 0 0 12px rgba(112, 240, 196, 0.12);
      animation: glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: inset 0 0 12px rgba(112, 240, 196, 0.12); }
      to { box-shadow: inset 0 0 12px rgba(112, 240, 196, 0.24); }
    }
    
    /* Loading State Animations */
    .loading {
      position: relative;
      overflow: hidden;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { left: -100%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body>
  <!-- Skip Navigation Link for Accessibility -->
  <a href="#main-content" class="sr-only">Skip to main content</a>
  
  <!-- Header Section -->
  <header role="banner">
    <div style="font-size:18px" aria-hidden="true">✝️</div>
    <div>
      <h1>bibleRPG</h1>
      <div class="subtitle">Hear What The Spirit Says To The Soul!</div>
    </div>
  </header>

  <!-- Main Game Content -->
  <main id="main-content" role="main">
    <!-- Adventure Section -->
    <section class="card" aria-live="polite" aria-atomic="true" aria-label="Adventure section">
      <h2 id="adventure-heading">Adventure</h2>
      <div class="section stack">
        <!-- Location and Travel Controls -->
        <div class="row" id="locationRow">
          <span class="pill" aria-label="Current location">
            <span aria-hidden="true">📍</span>
            <strong id="locName" aria-describedby="location-description">Location</strong>
          </span>
          <label class="pill" for="travelSelect">
            <span aria-hidden="true">🧭</span>
            <strong>Travel</strong>
          </label>
          <select 
            id="travelSelect" 
            aria-label="Choose destination to travel to"
            aria-describedby="travel-help"
          ></select>
          <button class="btn" id="travelBtn" aria-describedby="travel-help">Go</button>
          <button 
            class="btn" 
            id="resetBtn" 
            title="Clear all progress and restart game"
            aria-label="Reset game progress"
          >Reset</button>
        </div>
        <div id="travel-help" class="sr-only">
          Select a destination from the dropdown and click Go to travel there
        </div>

        <!-- Game Scenario and Choices -->
        <div class="stack">
          <div 
            id="scenario" 
            class="section" 
            style="background:#0f132e;border:1px solid #262f68;border-radius:10px"
            role="region"
            aria-label="Current scenario"
            aria-live="polite"
          ></div>
          <div 
            class="btn-row" 
            id="choices"
            role="group"
            aria-label="Available choices"
          ></div>
        </div>

        <!-- Character Stats Display -->
        <div class="stack" role="region" aria-label="Character statistics">
          <div class="kv">
            <div>Faith</div>
            <div class="bar" title="Faith level progress" role="progressbar" aria-label="Faith progress">
              <i id="faithBar" aria-hidden="true"></i>
            </div>
            <div>Wisdom</div>
            <div class="bar" title="Wisdom level progress" role="progressbar" aria-label="Wisdom progress">
              <i id="wisdomBar" aria-hidden="true"></i>
            </div>
            <div>Service</div>
            <div class="bar" title="Service level progress" role="progressbar" aria-label="Service progress">
              <i id="serviceBar" aria-hidden="true"></i>
            </div>
          </div>
          <div class="divider" aria-hidden="true"></div>
          <div class="row">
            <div class="title-ribbon" role="status" aria-label="Current title">
              <span aria-hidden="true">🏅</span>
              <span id="titleValue">Service Title</span>
            </div>
          </div>
        </div>

        <!-- Event Log Section -->
        <div role="region" aria-label="Game events">
          <h3 style="margin:8px 0 6px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">
            Event log
          </h3>
          <div 
            class="log" 
            id="log" 
            role="log" 
            aria-live="polite"
            aria-label="Recent game events"
            tabindex="0"
          ></div>
        </div>
      </div>
    </section>

    <!-- Profile Sidebar -->
    <aside class="card" role="complementary" aria-label="Player profile">
      <h2 id="profile-heading">Profile</h2>
      <div class="section stack">
        <!-- Character Stats Summary -->
        <div class="stack" role="region" aria-labelledby="stats-heading">
          <div class="row">
            <span class="pill" id="stats-heading">
              <span aria-hidden="true">📊</span>
              <strong>Stats</strong>
            </span>
          </div>
          <div class="kv" aria-label="Character statistics values">
            <div>Faith:</div>
            <div id="faithVal" aria-label="Faith value">0</div>
            <div>Wisdom:</div>
            <div id="wisdomVal" aria-label="Wisdom value">0</div>
            <div>Service:</div>
            <div id="serviceVal" aria-label="Service value">0</div>
          </div>
        </div>

        <div class="divider" aria-hidden="true"></div>

        <!-- Rewards Section -->
        <div class="stack" role="region" aria-labelledby="rewards-heading">
          <div class="row">
            <span class="pill" id="rewards-heading">
              <span aria-hidden="true">🎁</span>
              <strong>Rewards:</strong>
            </span>
          </div>
          <div 
            id="rewards" 
            class="row"
            aria-label="Collected rewards"
            aria-describedby="rewards-description"
          ></div>
          <div id="rewards-description" class="sr-only">
            This section displays rewards you have earned through completing quests and achieving milestones
          </div>
        </div>

        <div class="divider" aria-hidden="true"></div>

        <!-- Quest Information -->
        <div class="stack" role="region" aria-labelledby="quest-heading">
          <div class="row">
            <span class="pill" id="quest-heading">
              <span aria-hidden="true">🗡️</span>
              <strong>Quest:</strong>
            </span>
          </div>
          <div 
            id="questBox" 
            class="stack"
            aria-label="Current quest information"
            aria-live="polite"
          ></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="footer" role="contentinfo">
    <span>2025 @ bibleRPG</span>
    <span class="sr-only"> - Biblical Role Playing Game</span>
  </footer>

  <script id="game-script">
    'use strict';
    
    /* ==============================================
       Game Data Configuration
       ============================================== */
    
    // Available locations in the biblical world
    const LOCATIONS = [
      'Galilee', 'Jerusalem', 'Bethlehem', 'Damascus', 
      'Wilderness', 'Israel', 'Sea of Galilee', 'Babylon'
    ];

    // Descriptive flavor text for each location
    const locationFlavors = {
      Galilee: [
        'You arrive by the Sea of Galilee as dawn gilds the water.',
        'Fishermen mend their nets; gulls arc over the tide.',
        'A hush falls as the wind softens across the shore.'
      ],
      Jerusalem: [
        'Stone steps climb toward the Temple courts, alive with voices.',
        'Shadows of pillars stretch long across the courtyard.',
        'Whispers of prophecy linger in the narrow streets.'
      ],
      Bethlehem: [
        'The city of David welcomes you with ancient songs.',
        'Shepherds\' fields stretch beneath starlit skies.',
        'Peace descends like gentle rainfall.'
      ],
      Damascus: [
        'Ancient trade routes converge in this bustling city.',
        'The scent of spices fills the marketplace air.',
        'Voices of many nations echo through the streets.'
      ],
      Wilderness: [
        'Silence stretches across the barren landscape.',
        'Rocky paths wind between sparse vegetation.',
        'Solitude invites deep contemplation.'
      ]
    };

    // Quest configurations for different locations
    const questPool = {
      Galilee: [
        {
          id: 'fishers_of_men',
          description: 'Share the Good News with the villagers by the shore.',
          requirements: { faith: 2 },
          reward: { type: 'title', value: 'Fisher of Men' },
          scripture: 'Matthew 4:19'
        },
        {
          id: 'calm_the_storm',
          description: 'Pray for calm as the winds rise over the sea.',
          requirements: { faith: 4, wisdom: 2 },
          reward: { type: 'miracle', value: 'Calmed Storm' },
          scripture: 'Mark 4:39'
        },
        {
          id: 'feeding_multitude',
          description: 'Help distribute food to the hungry crowd.',
          requirements: { service: 3 },
          reward: { type: 'miracle', value: 'Multiplication of Loaves' },
          scripture: 'Matthew 14:19-20'
        }
      ],
      Jerusalem: [
        {
          id: 'teach_in_temple',
          description: 'Engage in debate with the teachers in the temple courts.',
          requirements: { wisdom: 3 },
          reward: { type: 'item', value: 'Scroll of Insight' },
          scripture: 'Luke 2:46-47'
        },
        {
          id: 'cleanse_temple',
          description: 'Help restore the sanctity of the temple.',
          requirements: { faith: 3, service: 2 },
          reward: { type: 'favor', value: 'Temple Authority' },
          scripture: 'Matthew 21:12-13'
        }
      ],
      Bethlehem: [
        {
          id: 'shepherd_watch',
          description: 'Keep vigil with the shepherds in the fields.',
          requirements: { faith: 1 },
          reward: { type: 'vision', value: 'Heavenly Host' },
          scripture: 'Luke 2:8-14'
        }
      ],
      Damascus: [
        {
          id: 'road_revelation',
          description: 'Encounter divine revelation on the road.',
          requirements: { faith: 5 },
          reward: { type: 'miracle', value: 'Blinded by Light' },
          scripture: 'Acts 9:3-6'
        }
      ]
    };

    // Milestone rewards for reaching stat thresholds
    const milestones = {
      faith: { 
        5: { type: 'miracle', value: 'Parted Waters' },
        10: { type: 'miracle', value: 'Resurrection Power' }
      },
      wisdom: { 
        5: { type: 'miracle', value: 'Prophetic Vision' },
        10: { type: 'miracle', value: 'Divine Wisdom' }
      },
      service: { 
        5: { type: 'miracle', value: 'Feeding the Multitude' },
        10: { type: 'miracle', value: 'Healing Touch' }
      }
    };

    // Location-based special blessings
    const locationBlessings = {
      Galilee: [
        {
          requirements: { faith: 3 },
          blessing: { type: 'vision', value: 'A net overflowing with fish — a promise of abundance.' },
          scripture: 'Luke 5:6'
        }
      ],
      Jerusalem: [
        {
          requirements: { wisdom: 4, service: 2 },
          blessing: { type: 'favor', value: 'The elders grant you access to the inner courts.' },
          scripture: 'Acts 6:10'
        }
      ],
      Bethlehem: [
        {
          requirements: { faith: 2 },
          blessing: { type: 'vision', value: 'Angels sing Gloria in Excelsis Deo.' },
          scripture: 'Luke 2:14'
        }
      ]
    };

    const choicesData = [
      { id:'faith_choice', label:'🙏 Wait upon the Lord’s guidance', stat:'faith', scripture:'Isaiah 40:31' },
      { id:'wisdom_choice', label:'📖 Seek counsel from the elders', stat:'wisdom', scripture:'Proverbs 11:14' },
      { id:'service_choice', label:'🤝 Help the wounded traveler', stat:'service', scripture:'Luke 10:33–34' }
    
    /* ==============================================
       Tutorial System Configuration
       ============================================== */
    const tutorialSteps = [
      {
        id: 'welcome',
        title: 'Welcome to bibleRPG!',
        content: 'Embark on a spiritual journey through biblical lands. Your goal is to grow in Faith, Wisdom, and Service.',
        target: null,
        action: 'next'
      },
      {
        id: 'stats',
        title: 'Character Stats',
        content: 'Monitor your Faith, Wisdom, and Service levels. These determine which quests you can undertake.',
        target: '#faithVal',
        action: 'next'
      },
      {
        id: 'choices',
        title: 'Making Choices',
        content: 'Select actions based on biblical principles. Each choice affects your spiritual growth.',
        target: '#choices',
        action: 'next'
      },
      {
        id: 'travel',
        title: 'Traveling',
        content: 'Visit different biblical locations to discover new quests and opportunities for growth.',
        target: '#travelSelect',
        action: 'finish'
      }
    ];

    /* ==============================================
       State Management & Persistence
       ============================================== */
    const STORAGE_KEY = 'gospel_rpg_state_v2'; // Incremented for new features

    const defaultState = () => ({
      stats: { faith: 0, wisdom: 0, service: 0 },
      location: 'Galilee', // Default starting location
      rewards: [], // array of {type, value}
      items: [], // derived from rewards  
      title: '', // Current character title
      achievedMilestones: {}, // e.g., "faith:5": true
      currentQuest: null,
      log: [],
      tutorialCompleted: false,
      tutorialStep: 0,
      gameStartTime: Date.now(),
      playTime: 0
    });

    let state = load();

    /* ==============================================
       Storage and State Management Functions
       ============================================== */
    function save() { 
      try {
        state.playTime += Date.now() - state.gameStartTime;
        state.gameStartTime = Date.now();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (error) {
        console.error('Failed to save game state:', error);
        addLog('⚠️ Warning: Could not save progress.');
      }
    }
    
    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const loadedState = raw ? JSON.parse(raw) : defaultState();
        
        // Ensure all new properties exist for backward compatibility
        const completeState = { ...defaultState(), ...loadedState };
        completeState.gameStartTime = Date.now();
        
        return completeState;
      } catch (error) {
        console.error('Failed to load game state:', error);
        addLog('⚠️ Warning: Could not load saved progress. Starting fresh.');
        return defaultState();
      }
    }
    
    function reset() {
      try {
        state = defaultState();
        addLog('🔄 Progress reset. Welcome back!');
        
        if (!state.tutorialCompleted) {
          startTutorial();
        } else {
          enterLocation(state.location, { announce: false });
        }
        
        render();
        save();
      } catch (error) {
        console.error('Failed to reset game:', error);
        addLog('❌ Error resetting game. Please refresh the page.');
      }
    }

    
    /* ==============================================
       Utility Functions - Modernized with ES6+
       ============================================== */
    const $ = (selector) => {
      try {
        return document.querySelector(selector);
      } catch (error) {
        console.error(`Invalid selector: ${selector}`, error);
        return null;
      }
    };
    
    const $$ = (selector) => {
      try {
        return document.querySelectorAll(selector);
      } catch (error) {
        console.error(`Invalid selector: ${selector}`, error);
        return [];
      }
    };
    
    // Enhanced DOM element creation with error handling
    const el = (tag, props = {}, children = []) => {
      try {
        const element = document.createElement(tag);
        
        Object.entries(props).forEach(([key, value]) => {
          if (key === 'class') {
            element.className = value;
          } else if (key === 'html') {
            element.innerHTML = value;
          } else if (key === 'style' && typeof value === 'object') {
            Object.assign(element.style, value);
          } else {
            element.setAttribute(key, value);
          }
        });
        
        [].concat(children).forEach(child => {
          if (typeof child === 'string') {
            element.appendChild(document.createTextNode(child));
          } else if (child && child.nodeType) {
            element.appendChild(child);
          }
        });
        
        return element;
      } catch (error) {
        console.error('Error creating element:', error);
        return document.createElement('div'); // Fallback
      }
    };
    
    // Random selection utility
    const pick = (array) => {
      if (!Array.isArray(array) || array.length === 0) {
        console.warn('pick() called with invalid array');
        return null;
      }
      return array[Math.floor(Math.random() * array.length)];
    };
    
    // Requirement checking utility  
    const meets = (stats, requirements) => {
      if (!stats || !requirements) return false;
      return Object.entries(requirements).every(([stat, value]) => (stats[stat] || 0) >= value);
    };
    
    // Reward utilities
    const rewardKey = (reward) => `${reward.type}:${reward.value}`;
    const hasReward = (reward) => state.rewards.some(r => rewardKey(r) === rewardKey(reward));
    
    // Enhanced logging with timestamps
    const addLog = (line) => {
      if (!line) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${line}`;
      
      state.log.unshift(logEntry);
      state.log = state.log.slice(0, 100); // Keep last 100 entries
      
      // Auto-save on important events
      save();
    
    /* ==============================================
       Tutorial System Implementation
       ============================================== */
    const startTutorial = () => {
      if (state.tutorialCompleted) return;
      
      state.tutorialStep = 0;
      showTutorialStep();
    };
    
    const showTutorialStep = () => {
      const step = tutorialSteps[state.tutorialStep];
      if (!step) {
        completeTutorial();
        return;
      }
      
      const modal = createTutorialModal(step);
      document.body.appendChild(modal);
    };
    
    const createTutorialModal = (step) => {
      const modal = el('div', {
        class: 'tutorial-modal',
        style: {
          position: 'fixed',
          top: '0',
          left: '0',
          right: '0',
          bottom: '0',
          background: 'rgba(0, 0, 0, 0.8)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: '1000'
        }
      }, [
        el('div', {
          class: 'tutorial-content',
          style: {
            background: 'var(--panel)',
            border: '1px solid var(--accent)',
            borderRadius: '12px',
            padding: '24px',
            maxWidth: '400px',
            color: 'var(--text)',
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.5)'
          }
        }, [
          el('h3', { style: { marginTop: '0', color: 'var(--accent)' } }, [step.title]),
          el('p', { style: { lineHeight: '1.6' } }, [step.content]),
          el('div', { 
            style: { 
              display: 'flex', 
              gap: '10px', 
              justifyContent: 'flex-end',
              marginTop: '20px'
            } 
          }, [
            step.action === 'finish' ? 
              el('button', { 
                class: 'btn',
                style: { background: 'var(--good)' }
              }, ['Start Playing!']) :
              el('button', { class: 'btn' }, ['Next'])
          ])
        ])
      ]);
      
      // Add click handler
      const button = modal.querySelector('button');
      button.addEventListener('click', () => {
        document.body.removeChild(modal);
        nextTutorialStep();
      });
      
      return modal;
    };
    
    const nextTutorialStep = () => {
      state.tutorialStep++;
      save();
      
      if (state.tutorialStep >= tutorialSteps.length) {
        completeTutorial();
      } else {
        setTimeout(showTutorialStep, 300);
      }
    };
    
    const completeTutorial = () => {
      state.tutorialCompleted = true;
      state.tutorialStep = 0;
      addLog('🎓 Tutorial completed! Begin your biblical journey.');
      save();
      
      // Start the actual game
      enterLocation('Galilee', { announce: true });
      render();
    };

    /* ==============================================
       Core Game Systems
       ============================================== */
    const scenarioFor = (location) => {
      const flavors = locationFlavors[location];
      return pick(flavors || ['You continue on your way.']);
    };

    function assignQuest(location){
      const pool = questPool[location] || [];
      const candidates = pool.filter(q => meets(state.stats, q.requirements));
      if(!candidates.length) return null;
      return pick(candidates);
    }

    function applyReward(reward){
      if(!hasReward(reward)) state.rewards.push(reward);

      switch(reward.type){
        case 'miracle':
          addLog(`🌟 Miracle! ${reward.value}`);
          return `🌟 Miracle! ${reward.value}`;
        case 'title':
          state.title = reward.value;
          addLog(`🏅 You are now known as “${reward.value}”.`);
          return `🏅 You are now known as “${reward.value}”.`;
        case 'item':
          if(!state.items.includes(reward.value)) state.items.push(reward.value);
          addLog(`📦 You obtained: ${reward.value}`);
          return `📦 You obtained: ${reward.value}`;
        case 'vision':
          addLog(`👁️ Vision: ${reward.value}`);
          return `👁️ Vision: ${reward.value}`;
        case 'favor':
          addLog(`💠 Favor: ${reward.value}`);
          return `💠 Favor: ${reward.value}`;
        default:
          return '';
      }
    }

    function checkMilestones(){
      const notes = [];
      for(const stat of Object.keys(milestones)){
        const cur = state.stats[stat] || 0;
        const table = milestones[stat] || {};
        if(table[cur]){
          const key = `${stat}:${cur}`;
          if(!state.achievedMilestones[key]){
            state.achievedMilestones[key] = true;
            notes.push(applyReward(table[cur]));
          }
        }
      }
      return notes;
    }

    function checkLocationBlessings(location){
      const list = locationBlessings[location] || [];
      const notes = [];
      list.forEach(b => {
        if(meets(state.stats, b.requirements)){
          notes.push(`${applyReward(b.blessing)} (${b.scripture})`);
        }
      });
      return notes;
    }

    function enterLocation(location, {announce=true}={}){
      state.location = location;
      const lines = [];

      if(announce){
        lines.push(`🧭 You arrive in ${location}.`);
      }
      lines.push(scenarioFor(location));

      const blessings = checkLocationBlessings(location);
      if(blessings.length) lines.push(...blessings);

      // Assign a quest if eligible (immediate completion demo)
      const q = assignQuest(location);
      state.currentQuest = q;
      if(q){
        lines.push(`🗡️ Quest: ${q.description} (${q.scripture})`);
        // In this single-file demo we auto-complete for momentum
        const rewardMsg = applyReward(q.reward);
        lines.push(`✅ Quest Completed: ${q.description}`);
        if(rewardMsg) lines.push(rewardMsg);
      }else{
        lines.push('🗡️ No quests available yet. Grow in your stats to unlock more.');
      }

      addLog(lines.join(' '));
      $('#scenario').innerHTML = lines.map(l => `<p>${l}</p>`).join('');
      save();
    }

    function handleChoice(choiceId){
      const choice = choicesData.find(c => c.id===choiceId);
      if(!choice) return;

      const stat = choice.stat;
      state.stats[stat] = (state.stats[stat]||0) + 1;

      const choiceLine = `✨ You chose: ${choice.label} (${choice.scripture})`;
      addLog(choiceLine);

      const milestoneNotes = checkMilestones();
      const nextIndex = (LOCATIONS.indexOf(state.location)+1) % LOCATIONS.length;
      const nextLoc = LOCATIONS[nextIndex];

      const lines = [choiceLine];
      if(milestoneNotes.length) lines.push(...milestoneNotes);

      $('#scenario').innerHTML = lines.map(l => `<p>${l}</p>`).join('');

      // Travel after a short beat to simulate turn flow
      setTimeout(()=>{
        enterLocation(nextLoc);
        render();
      }, 400);

      render();
      save();
    }

    // ----------------------------
    // UI wiring
    // ----------------------------
    function render(){
      // Location
      $('#locName').textContent = state.location;
      // Stats values
      $('#faithVal').textContent = state.stats.faith;
      $('#wisdomVal').textContent = state.stats.wisdom;
      $('#serviceVal').textContent = state.stats.service;
      // Bars (cap at 10 for display)
      const cap = v => Math.max(0, Math.min(10, v));
      $('#faithBar').style.width = (cap(state.stats.faith)*10)+'%';
      $('#wisdomBar').style.width = (cap(state.stats.wisdom)*10)+'%';
      $('#serviceBar').style.width = (cap(state.stats.service)*10)+'%';

      // Title
      $('#titleValue').textContent = state.title || 'No title yet';

      // Rewards
      const rewardsBox = $('#rewards');
      rewardsBox.innerHTML = '';
      if(!state.rewards.length){
        rewardsBox.appendChild(el('div',{class:'muted'},['No rewards yet']));
      }else{
        state.rewards.forEach(r=>{
          rewardsBox.appendChild(el('span',{class:'token'},[`${iconFor(r.type)} ${r.value}`]));
        });
      }

      // Quest box
      const qb = $('#questBox');
      qb.innerHTML = '';
      if(state.currentQuest){
        qb.appendChild(el('div',{class:'stack'},[
          el('div',{class:'row'},[el('span',{class:'pill'},[`📜 `, el('strong',{},['Description'])]), el('span',{},[state.currentQuest.description])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`📖 `, el('strong',{},['Scripture'])]), el('span',{},[state.currentQuest.scripture])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`🎯 `, el('strong',{},['Requirements'])]),
            el('span',{},[reqText(state.currentQuest.requirements)])]),
          el('div',{class:'row'},[el('span',{class:'pill'},[`🎁 `, el('strong',{},['Reward'])]),
            el('span',{},[`${state.currentQuest.reward.type}: ${state.currentQuest.reward.value}`])])
        ]));
      }else{
        qb.appendChild(el('div',{class:'muted'},['No active quest.']));
      }

      // Choices
      const choices = $('#choices');
      choices.innerHTML = '';
      choicesData.forEach(c=>{
        const btn = el('button',{class:'btn', id:c.id},[c.label]);
        const sub = el('small',{},[c.scripture]);
        const wrap = el('div',{class:'choice'},[btn, sub]);
        btn.addEventListener('click', ()=>handleChoice(c.id));
        choices.appendChild(wrap);
      });

      // Log
      const log = $('#log');
      log.innerHTML = state.log.map(line=>`<p>${line}</p>`).join('');
    }

    function iconFor(type){
      switch(type){
        case 'miracle': return '🌟';
        case 'title': return '🏅';
        case 'item': return '📦';
        case 'vision': return '👁️';
        case 'favor': return '💠';
        default: return '🎁';
      }
    }
    function reqText(reqs){
      const parts = [];
      if('faith' in reqs) parts.push(`Faith ${reqs.faith}+`);
      if('wisdom' in reqs) parts.push(`Wisdom ${reqs.wisdom}+`);
      if('service' in reqs) parts.push(`Service ${reqs.service}+`);
      return parts.join(', ') || 'None';
    }

    function initUI(){
      // Travel control
      const sel = $('#travelSelect');
      sel.innerHTML = '';
      LOCATIONS.forEach(loc=>{
        const o = el('option',{value:loc},[loc]);
        sel.appendChild(o);
      });
      sel.value = state.location;
      $('#travelBtn').addEventListener('click', ()=>{
        const dest = sel.value;
        if(dest && dest !== state.location){
          enterLocation(dest);
          render();
          save();
        }
      });
      // Reset
      $('#resetBtn').addEventListener('click', reset);
    }

    // ----------------------------
    // Boot
    // ----------------------------
    window.addEventListener('DOMContentLoaded', ()=>{
      initUI();
      // First-time arrival narrative
      if(state.log.length===0){
        enterLocation(state.location, {announce:true});
      }else{
        // Ensure scenario shows something on reload
        $('#scenario').innerHTML = state.log.slice(0,3).reverse().map(l=>`<p>${l}</p>`).join('');
      }
      render();
      save();
    });
  </script>
</body>
</html>
